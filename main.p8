pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
-- main
g = {} -- games state
c = {} -- config

function _init()
 -- mmenu_ini()
 cmbt_ini()
end

function _update()
 g.upd()
end

function _draw()
 g.drw()
end
-->8
-- main menu

function mmenu_ini()
 g.upd = mmenu_upd
 g.drw = mmenu_drw
end

function mmenu_upd()
 if btn(ðŸ…¾ï¸) or btn(âŽ) then
  ctscn_ini()
 end
end

function mmenu_drw()
 cls()
 print("press ðŸ…¾ï¸/âŽ to start")
end
-->8
-- cutscene/dialogue
ctscn = {start=0}

function ctscn_ini()
 ctscn.start = time()
 g.upd = ctscn_upd
 g.drw = ctscn_drw
end

function ctscn_upd()
 if time()-ctscn.start < 1 then
  return
 end
 if time()-ctscn.start > 8 or
    btn(âŽ) or btn(ðŸ…¾ï¸) then
  cmbt_ini()
 end
end

function ctscn_drw()
 cls()
 local t = time() - ctscn.start
 local s = "hello"
 if t > 1 then
  s = s..sub("...",1,t-1)
 end
 if t > 5 then
  s = s.." this is the end of the\nscene"
 end
 print(s)
end
-->8
-- non-combat exploration
-->8
-- combat
function render_path(pc)
 if #pc.tail == 0 then
  return
 end
 for p in all(pc.tail) do
  local x0 = p[1]*8-1
  local y0 = p[2]*8
  rect(x0,y0,x0+8,y0+8,8)
 end
end

function end_turn(pc)
 c.player_turn = c.player_turn % 2 + 1
 pc.tail = {}
end

function move_pc(pc,di,dj)
 local nxt = {pc.i+di,
        pc.j+dj}
 
 local nw_tail = {}
 for p in all(pc.tail) do
  if nxt[1]==p[1] and
     nxt[2]==p[2] then
   break
  end
  add(nw_tail, p)
 end
 -- if the tail is growing
 -- then add our current pos
 -- as the end of the tail
 if #nw_tail >= #pc.tail then
  add(nw_tail, {pc.i, pc.j})
 end

 -- if open and we have 
 -- movement we can move there 
 if mget(nxt[1],nxt[2]) == 2 and
    (pc.mvmt-#nw_tail) >= 0 then
  pc.i = nxt[1]
  pc.j = nxt[2]
  pc.tail = nw_tail
 end
end

function cmbt_ini()
 g.upd = cmbt_upd
 g.drw = cmbt_drw

 c.players = {}
 local pc = {
  i=4, 
  j=4, 
  mvmt=8, 
  tail={}, 
  sp=1}
 add(c.players,pc)
 local pc = { 
  i = 8, 
  j = 4, 
  mvmt=6, 
  tail={}, 
  sp=6}
 add(c.players,pc)
 c.num_turns = #c.players
 c.player_turn = 1
end

function cmbt_upd()
 local pc = c.players[c.player_turn]
 if (btnp(â¬…ï¸)) move_pc(pc,-1, 0)
 if (btnp(âž¡ï¸)) move_pc(pc, 1, 0)
 if (btnp(â¬†ï¸)) move_pc(pc, 0,-1)
 if (btnp(â¬‡ï¸)) move_pc(pc, 0, 1)
 if (btnp(4))  end_turn(pc)
end

function cmbt_drw()
 cls()
 map()
 for pc in all(c.players) do
  spr(pc.sp,pc.i*8,pc.j*8)
 end
 color(8)
 local pc = c.players[c.player_turn]
 print(c.player_turn)
 render_path(pc)
 print(5*(pc.mvmt-#pc.tail))
end
-->8
-- credits
__gfx__
00000000000000006666666688888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000c000c001111111600000008050005000400040007000700000000000000000000000000000000000000000000000000000000000000000000000000
00700700cec0cec011111116000000085e505e504e404e407e707e70000000000000000000000000000000000000000000000000000000000000000000000000
00077000cec0cec011111116000000085e505e504e404e407e707e70000000000000000000000000000000000000000000000000000000000000000000000000
00077000ccccccc01111111600000008555555504444444077777770000000000000000000000000000000000000000000000000000000000000000000000000
00700700c0ccc0c01111111600000008505550504044404070777070000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccccccc01111111600000008555555504444444077777770000000000000000000000000000000000000000000000000000000000000000000000000
000000000ccecc001111111600000008055e5500044e4400077e7700000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
